<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="shortcut icon" href="__PUBLIC_IMG__/3.ico"/>
  <title>Automation Test System | Add Tool</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="stylesheet" href="__PUBLIC_CSS__/bootstrap/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="__PUBLIC_CSS__/font-awesome/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="__PUBLIC_CSS__/Ionicons/ionicons.min.css">
    <!-- Select2 -->
    <link rel="stylesheet" href="__PUBLIC_CSS__/select2/select2.min.css">
    <!-- BS Select -->
    <!--<link rel="stylesheet" href="__PUBLIC_CSS__/bootstrap-select/css/bootstrap-select.min.css">-->
    <!--PACE-->
  <link rel="stylesheet" href="__PUBLIC_CSS__/pace/pace.css">
    <!-- iCheck for checkboxes and radio inputs -->
    <link rel="stylesheet" href="__PUBLIC_CSS__/iCheck/all.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="__PUBLIC_CSS__/AdminLTE/AdminLTE.min.css">
  <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
        page. However, you can choose any other skin. Make sure you
        apply the skin class to the body tag so the changes take effect. -->
  <link rel="stylesheet" href="__PUBLIC_CSS__/skins/skin-purple.css">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="__PUBLIC_CSS__/html5shiv.min.js"></script>
    <script src="__PUBLIC_CSS__/respond.min.js"></script>
    <![endif]-->

  <!-- Google Font -->
    <link rel="stylesheet" href="__PUBLIC_CSS__/googleFont.css">
</head>
<!--
BODY TAG OPTIONS:
=================
Apply one or more of the following classes to get the
desired effect
|---------------------------------------------------------|
| SKINS         | skin-blue                               |
|               | skin-black                              |
|               | skin-purple                             |
|               | skin-yellow                             |
|               | skin-red                                |
|               | skin-green                              |
|---------------------------------------------------------|
|LAYOUT OPTIONS | fixed                                   |
|               | layout-boxed                            |
|               | layout-top-nav                          |
|               | sidebar-collapse                        |
|               | sidebar-mini                            |
|---------------------------------------------------------|
-->
<!--<body class="hold-transition skin-blue sidebar-mini">-->
<body class="hold-transition skin-purple sidebar-collapse sidebar-mini">
<div class="wrapper">

    {include file="common/header" /}
  <!-- Left side column. contains the logo and sidebar -->
    {include file="common/sidebar" /}

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
      <section class="content">
          <div class="row">
              <div class="col-xs-12">
                  <div class="box box-default">
                      <div class="box-header with-border">
                          <h3 class="box-title">Selection</h3>
                      </div>
                      <div class="box-body">
                            <div class="row">
                                <div class="col-md-7">
                                    <select class="form-control select2" style="width: 100%;" name="selection"></select>
                                </div>
                                <input type="text" id="forCollapse" hidden>
                                <input type="text" id="knowTool" hidden>
                                <!--从taskManager页面传递过来的taskId-->
                                <input type="text" id="taskId" hidden value="{$taskId}">
                                <div class="col-md-5">
                                    <button type="button" class="btn btn-success" id="addTool"> Add Tool </button>
                                </div>
                            </div>

                      </div>
                  </div>
              </div>
          </div>
          <!--<select class="selectpicker" data-live-search="true" data-size="5"></select>-->

          <div class="box box-default panel-group" id="content" style="display: none">
              <div class="box-header with-border">
                  <h3 class="box-title">Add</h3>
              </div>
              <form  id="toolForm">
                  <div class="box-body" id="box_body"></div>
                  <div class="box-footer">
                      <button type="button" class="btn btn-primary pull-right" id="sub">Submit</button>
                  </div>
              </form>
          </div>
      </section>
  </div>
  <!-- /.content-wrapper -->
    {include file="common/footer" /}

</div>
<!-- ./wrapper -->

<!-- REQUIRED JS SCRIPTS -->

<!-- jQuery 3 -->
<script src="__PUBLIC_JS__/jquery/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="__PUBLIC_JS__/bootstrap/bootstrap.min.js"></script>
<!--PACE-->
<script src="__PUBLIC_JS__/pace/pace.js"></script>
<!-- Select2 -->
<script src="__PUBLIC_JS__/select2/select2.min.js"></script>
<!-- BS Select2 -->
<!--<script src="__PUBLIC_JS__/bootstrap-select/js/bootstrap-select.min.js"></script>-->
<!-- iCheck 1.0.1 -->
<script src="__PUBLIC_JS__/iCheck/icheck.min.js"></script>
<!-- AdminLTE App -->
<script src="__PUBLIC_JS__/adminlte/adminlte.min.js"></script>

<script>
    $(function () {

        // $('.selectpicker').selectpicker();

        // selection for toolName
        $('.select2').select2({
                width: "100%",
                ajax: {
                    url: "{:url('AddTool/getToolName')}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term // search term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data
                        };
                    },
                    cache: false
                },
                placeholder: 'Please Select',
                allowClear: true
            }

        );
        // init select2 data
        $.ajax({
            type: 'post',
            url: "{:url('AddTool/getToolName', 'type=init')}",
            dataType: 'json',
            success: function (data) {
                var option = new Option(data[0].text, data[0].id, true, true);
                $('select[name="selection"]').append(option);
            }
        });

        $('#content').on('click', '.delete', function () {
            $(this).parent().parent().parent().remove();
            var buttonCount = $('.delete').length;
            if (0 == buttonCount) {
                $('#content').css('display', 'none');
            }

        });


        $('#addTool').click(function () {
            var selection, toolId;
            try {
                selection= $('select[name="selection"]').select2('data')[0].text;
                toolId = $('select[name="selection"]').select2('data')[0].id;
            } catch (e) {
                if (undefined == selection || null == selection) {
                    toastr.error(" Please Select Tool");
                    return false;
                }
            }

            var collapseId = Number($('#forCollapse').text()); // 初始值为0

            $.ajax({
                type : "post",
                url: "{:url('AddTool/createAddToolElement')}",
                data: {
                    toolId : toolId,
                    selection : selection,
                    collapseId : collapseId
                },
                success : function (result) {
                    if ('none' === $('#content').css('display')){
                        $('#content').css('display', 'block');
                    }

                    $('#box_body').append('<div>' + result +'</div>');
                },
                error : function(){
                    toastr.error("Add Fail, Try Again");
                },
                complete: function () {
                    $('#forCollapse').text(collapseId + 1);
                }
            });
        });
        // submit
        $('#sub').click(function () {
            validateFormData();
            
            console.log($('#toolForm').serialize());
            $.ajax({
                type : "post",
                url: "{:url('AddTool/insertTool')}",
                data: {
                    taskId: $('#taskId').val(),
                    formData : $('#toolForm').serialize(),
                    knowTool : getToolString()
                },
                success : function (result) {
                    if ("done" == result) {
                        toastr.success("Add Tool Steps Success");
                        setTimeout("window.location.href=\"TaskManager\";",1500);
                    }

                },
                error : function(){
                    toastr.error("Submit Fail, Try Again");
                }

            })

        });

        function validateFormData() {
            // select option required
            $('#content').find('select').each(function (i) {
                if (null == $(this).val() || undefined == $(this).val()){
                    var target = $(this).attr('name').split('_')[0];
                    toastr.error(target + " Can't Be Empty");
                    return false;
                }

            });

        }
        // 获得工具string
        function getToolString() {
            var str = "";
            $('#content').find('button[data-toggle="collapse"]').each(function (i) {

                str = str + $(this).children().html() + ",";
            })
            return str.substring(0, str.length - 1);
        }
    });
</script>

</body>
</html>