<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="shortcut icon" href="__PUBLIC_IMG__/3.ico"/>
    <title>Automation Test System | Add Tool</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="__PUBLIC_CSS__/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="__PUBLIC_CSS__/font-awesome/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="__PUBLIC_CSS__/Ionicons/ionicons.min.css">
    <!-- Select2 -->
    <link rel="stylesheet" href="__PUBLIC_CSS__/select2/select2.min.css">
    <!-- BS Select -->
    <!--<link rel="stylesheet" href="__PUBLIC_CSS__/bootstrap-select/css/bootstrap-select.min.css">-->
    <!--PACE-->
    <link rel="stylesheet" href="__PUBLIC_CSS__/pace/pace.css">
    <!-- iCheck for checkboxes and radio inputs -->
    <link rel="stylesheet" href="__PUBLIC_CSS__/iCheck/all.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="__PUBLIC_CSS__/AdminLTE/AdminLTE.min.css">
    <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
          page. However, you can choose any other skin. Make sure you
          apply the skin class to the body tag so the changes take effect. -->
    <link rel="stylesheet" href="__PUBLIC_CSS__/skins/skin-purple.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="__PUBLIC_CSS__/html5shiv.min.js"></script>
    <script src="__PUBLIC_CSS__/respond.min.js"></script>
    <![endif]-->

    <!-- Google Font -->
    <link rel="stylesheet" href="__PUBLIC_CSS__/googleFont.css">
</head>
<!--
BODY TAG OPTIONS:
=================
Apply one or more of the following classes to get the
desired effect
|---------------------------------------------------------|
| SKINS         | skin-blue                               |
|               | skin-black                              |
|               | skin-purple                             |
|               | skin-yellow                             |
|               | skin-red                                |
|               | skin-green                              |
|---------------------------------------------------------|
|LAYOUT OPTIONS | fixed                                   |
|               | layout-boxed                            |
|               | layout-top-nav                          |
|               | sidebar-collapse                        |
|               | sidebar-mini                            |
|---------------------------------------------------------|
-->
<!--<body class="hold-transition skin-blue sidebar-mini">-->
<body class="hold-transition skin-purple sidebar-collapse sidebar-mini">
<div class="wrapper">

    {include file="common/header" /}
    <!-- Left side column. contains the logo and sidebar -->
    {include file="common/sidebar" /}

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <section class="content">
            <div class="row">
                <div class="col-xs-12">
                    <div class="box box-default">
                        <div class="box-header with-border">
                            <h3 class="box-title">Selection</h3>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-md-7">
                                    <select class="form-control" style="width: 100%;" name="selection"></select>
                                </div>
                                <input type="text" id="forCollapse" hidden>
                                <!--从taskManager页面传递过来的taskId-->
                                <input type="text" id="taskId" hidden value="{$taskId}">
                                <div class="col-md-5">
                                    <button type="button" class="btn btn-success" id="addTool"> Add Tool </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <!--<select class="selectpicker" data-live-search="true" data-size="5"></select>-->

            <div class="box box-default panel-group" id="content" style="display: none">
                <div class="box-header with-border">
                    <h3 class="box-title">Add</h3>
                </div>
                <form  id="toolForm">
                    <div class="box-body" id="box_body"></div>
                    <div class="box-footer">
                        <button type="button" class="btn btn-primary pull-right" id="sub">Submit</button>
                    </div>
                </form>
            </div>
        </section>
    </div>
    <!-- /.content-wrapper -->
    {include file="common/footer" /}

</div>
<!-- ./wrapper -->

<!-- REQUIRED JS SCRIPTS -->

<!-- jQuery 3 -->
<script src="__PUBLIC_JS__/jquery/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="__PUBLIC_JS__/bootstrap/bootstrap.min.js"></script>
<!--PACE-->
<script src="__PUBLIC_JS__/pace/pace.js"></script>
<!-- Select2 -->
<script src="__PUBLIC_JS__/select2/select2.min.js"></script>
<!-- BS Select2 -->
<!--<script src="__PUBLIC_JS__/bootstrap-select/js/bootstrap-select.min.js"></script>-->
<!-- iCheck 1.0.1 -->
<script src="__PUBLIC_JS__/iCheck/icheck.min.js"></script>
<!-- AdminLTE App -->
<script src="__PUBLIC_JS__/adminlte/adminlte.min.js"></script>

<script>
    $(function () {

        // $('.selectpicker').selectpicker();

        // selection for toolName
        $('select[name="selection"]').select2({
                width: "100%",
                ajax: {
                    url: "{:url('AddTool/getToolName')}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term // search term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data
                        };
                    },
                    cache: false
                },
                placeholder: 'Please Select',
                allowClear: true
            }

        ).html('<option value="' + 'JumpStart' + '">' + 'JumpStart' + '</option>').trigger("change");

        $('#content').on('click', '.delete', function () {
            $(this).parent().parent().parent().parent().remove();
            var buttonCount = $('.delete').length;
            if (0 === buttonCount) {
                $('#content').css('display', 'none');
            }

        }).on('click', '.addButton', function () {
            addToolByButton(2, $(this));

        });

        $.ajax({
            type : "post",
            url: "{:url('ToolHandler/setTool')}",
            data: {
                taskId: $('#taskId').val()
            },
            success : function (result) {
                console.log(result);
                if (null !== result || undefined !== result) {
                    $('#content').css('display', 'block');
                    result = JSON.parse(result);
                    $('#forCollapse').val(result.length + 1);
                    $.each(result, function (i, item) {
                        if ('JumpStart' === item.Tool_Type) {
                            $('#box_body').append('<div>' + setJumpStart(i, item) + '</div>');
                            lastDiv = $('#box_body').children('div:last');
                            setJumpStartData(lastDiv, item);
                        }
                        if ('Recovery' === item.Tool_Type) {
                            $('#box_body').append('<div>' + setRecovery(i, item) + '</div>');
                            lastDiv = $('#box_body').children('div:last');
                            setRecoveryData(lastDiv, item);
                        }

                    })

                }

            },
            error : function(){
                toastr.error("Get Data Fail, Try Again");
                setTimeout("window.location.href=\"TaskManager\";",1500);
            }

        })

        $('#addTool').click(function () {
            addToolByButton(1);
        });


        // submit
        $('#sub').click(function () {
            validateFormData();
            updateJsonData(formToJson());

        });


    })

    function formToJson() {
        var obj = [];
        $('#toolForm').find('button[data-toggle="collapse"]').each(function (i) {

            _father = $(this).parent();
            toolType = $(this).children('b').html();

            _father.find("input[name^='OS Activation']:checked").each(function () {
                $(this)
            })
            if ('JumpStart' === toolType) {
                var item ={
                    Tool_Type:toolType,
                    Test_Image:_father.find("#TestImage").select2('data')[0].text,
                    Execute_Job:_father.find("#ExecuteJob").select2('data')[0].text,
                    OS_Activation:_father.find("input[name^='OS Activation']:checked").val() // OS Activation first
                }

                obj.push(item);
            } else if ('Recovery' === toolType) {
                var item ={
                    Tool_Type:toolType,
                    Test_Image:_father.find("#TestImage").select2('data')[0].text,
                    OS_Activation:_father.find("input[name^='OS Activation']:checked").val()
                }
                obj.push(item);
            }

        });
        return JSON.stringify(obj);
    }
    function updateJsonData(data) {
        $.ajax({
            type : "post",
            url: "{:url('ToolHandler/updateToolSteps')}",
            data: {
                taskId: $('#taskId').val(),
                formObj : data
            },
            success : function (result) {
                if ("done" == result) {
                    toastr.success("Update Tool Steps Success");
                    setTimeout("window.location.href=\"TaskManager\";",1500);
                }

            },
            error : function(){
                toastr.error("Submit Fail, Try Again");
            }

        })

    }

    function validateFormData() {
        // select option required
        $('#content').find('select').each(function (i) {
            if (null == $(this).val() || undefined == $(this).val()){
                var target = $(this).attr('name');
                toastr.error(target + " Can't Be Empty");
                return false;
            }

        });

    }

    function addToolByButton(type, obj) {
        var selection, toolId;
        try {
            selection= $('select[name="selection"]').select2('data')[0].text;
            toolId = $('select[name="selection"]').select2('data')[0].id;
        } catch (e) {
            if (undefined == selection || null == selection) {
                toastr.error(" Please Select Tool");
                return false;
            }
        }
        index = $('#forCollapse').val();
        $.ajax({
            type : "post",
            url: "{:url('ToolHandler/getTool')}",
            data: {
                toolId : toolId,
                selection : selection,
                collapseId : index
            },
            success : function (result) {
                if ('none' === $('#content').css('display')){
                    $('#content').css('display', 'block');
                }
                if (1 === type) {
                    $('#box_body').append('<div>' + result +'</div>');
                    lastDiv = $('#box_body').children('div:last');
                    addThenInit(selection, lastDiv);

                } else if (2 === type) {
                    lastDiv = obj.parent().parent().parent().parent();
                    lastDiv.after('<div>' + result +'</div>');
                    addThenInit(selection, lastDiv.next());

                }
            },
            error : function(){
                toastr.error("Add Fail, Try Again");
            },
            complete: function () {
                $('#forCollapse').val(index + 1);
            }
        });
    }

    function addThenInit(selection, obj) {
        if ('JumpStart' === selection) {
            // testImage
            obj.find('select[name="TestImage"]').each(function () {
                var _this = $(this);
                _this.select2({
                    width: "100%",
                    ajax: {
                        url: "{:url('AddTool/getTestImage')}",
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return {q: params.term};
                        },
                        processResults: function (data) {
                            return {results: data};
                        },
                        cache: false
                    },
                    placeholder: 'Please Select',
                    allowClear: true
                }).html('<option value="' + 'Keep Current Image' + '">' + 'Keep Current Image' + '</option>').trigger("change");

            });

            // Execute Job
            obj.find('.select').each(function () {
                $(this).select2();
            });
            // OS Activation
            obj.find('input[type="radio"].minimal').each(function () {
                $(this).iCheck(
                    {radioClass: 'iradio_minimal-blue'}
                );
            });


        } else if ('Recovery' === selection) {
            // testImage
            obj.find('select[name="TestImage"]').each(function () {
                var _this = $(this);
                _this.select2({
                    width: "100%",
                    ajax: {
                        url: "{:url('AddTool/getTestImage')}",
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return {q: params.term};
                        },
                        processResults: function (data) {
                            return {results: data};
                        },
                        cache: false
                    },
                    placeholder: 'Please Select',
                    allowClear: true
                });

            });
            // OS Activation
            obj.find('input[type="radio"].minimal').each(function () {
                $(this).iCheck(
                    {radioClass: 'iradio_minimal-blue'}
                );
            });


        }
    }

    function setJumpStart(i, item) {
        $template = '';

        $template = '<button type="button" class="btn btn-info btn-sm btn-block" data-toggle="collapse" data-target="#collapse_' + i +'">' + '<b>JumpStart</b></button>' +
                    '<div id="collapse_' + i +'" class="panel-collapse collapse in">'+
                    '    <div class="panel-body form-horizontal">'+
                    '        <div class="form-group">'+
                    '            <label class="col-sm-1 control-label">Test Image</label>'+
                    '            <div class="col-sm-4">'+
                    '                <select class="form-control select2" name="TestImage" id="TestImage"></select>'+
                    '            </div>'+
                    '            <label class="col-sm-1 control-label">Execute Job</label>'+
                    '            <div class="col-sm-4">'+
                    '                <select class="form-control select" name="ExecuteJob" id="ExecuteJob">'+
                    '                    <option>Fast Startup,Standby,Microsoft Edge</option>'+
                    '                    <option>Fast Startup</option>'+
                    '                    <option>BatteryLife</option>'+
                    '                    <option>Fast Startup,Standby,Microsoft Edge,BatteryLife,DataGrab</option>'+
                    '                </select>'+
                    '            </div>'+
                    '        </div>'+
                    '        <div class="form-group">'+
                    '            <label class="col-sm-1 control-label">OS Activation</label>'+
                    '            <div class="col-sm-4" style="padding-top: 7px;padding-left: 14px">'+
                    '                <label style="margin-right: 19px">'+
                    '                    <input type="radio" name="OS Activation_'+ i +'" class="minimal" value="YES"/> YES'+
                    '                </label>'+
                    '                <label style="margin-right: 19px">'+
                    '                    <input type="radio" name="OS Activation_'+ i +'" class="minimal" value="NO"/> NO'+
                    '                </label>'+
                    '            </div>'+
                    '        </div>'+
                    '        <hr>'+
                    '        <div class="col-md-6"><button type="button" class="btn bg-purple addButton col-md-offset-10"> Add</button></div>'+
                    '        <div class="col-md-6"><button type="button" class="btn bg-olive delete"> delete</button></div>'+
                    '    </div>'+
                    '</div>';
        return $template;
    }

    function setJumpStartData(obj, item) {
        // testImage
        obj.find('select[name="TestImage"]').each(function () {
            var _this = $(this);
            _this.select2({
                width: "100%",
                ajax: {
                    url: "{:url('AddTool/getTestImage')}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {q: params.term};
                    },
                    processResults: function (data) {
                        return {results: data};
                    },
                    cache: false
                },
                placeholder: 'Please Select',
                allowClear: true
            }).html('<option value="' + item.Test_Image + '">' + item.Test_Image + '</option>').trigger("change");

        });

        // Execute Job
        obj.find('.select').each(function () {
            $(this).select2().val(item.Execute_Job).trigger("change");;
        });
        // OS Activation
        obj.find('input[type="radio"].minimal').each(function () {
            $(this).iCheck(
                {radioClass: 'iradio_minimal-blue'}
            );

            if (item.OS_Activation == $(this).val()) {
                $(this).iCheck('check');
            }
        });

    }

    function setRecovery(i, item) {
        $template = '';

        $template = '<button type="button" class="btn btn-info btn-sm btn-block" data-toggle="collapse" data-target="#collapse_' + i +'">' + '<b>JumpStart</b></button>' +
            '<div id="collapse_' + i +'" class="panel-collapse collapse in">'+
            '    <div class="panel-body form-horizontal">'+
            '        <div class="form-group">'+
            '            <label class="col-sm-1 control-label">Test Image</label>'+
            '            <div class="col-sm-4">'+
            '                <select class="form-control select2" name="TestImage" id="TestImage"></select>'+
            '            </div>'+
            '            <label class="col-sm-1 control-label">OS Activation</label>'+
            '            <div class="col-sm-4" style="padding-top: 7px;padding-left: 14px">'+
            '                <label style="margin-right: 19px">'+
            '                    <input type="radio" name="OS Activation_'+ i +'" class="minimal" value="YES"/> YES'+
            '                </label>'+
            '                <label style="margin-right: 19px">'+
            '                    <input type="radio" name="OS Activation_'+ i +'" class="minimal" value="NO"/> NO'+
            '                </label>'+
            '            </div>'+
            '        </div>'+
            '        <hr>'+
            '        <div class="col-md-6"><button type="button" class="btn bg-purple addButton col-md-offset-10"> Add</button></div>'+
            '        <div class="col-md-6"><button type="button" class="btn bg-olive delete"> delete</button></div>'+
            '    </div>'+
            '</div>';

        return $template;

    }
    
    function  setRecoveryData(obj, item) {
        // testImage
        obj.find('select[name="TestImage"]').each(function () {
            var _this = $(this);
            _this.select2({
                width: "100%",
                ajax: {
                    url: "{:url('AddTool/getTestImage')}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {q: params.term};
                    },
                    processResults: function (data) {
                        return {results: data};
                    },
                    cache: false
                },
                placeholder: 'Please Select',
                allowClear: true
            }).html('<option value="' + item.Test_Image + '">' + item.Test_Image + '</option>').trigger("change");

        });

        // OS Activation
        obj.find('input[type="radio"].minimal').each(function () {
            $(this).iCheck(
                {radioClass: 'iradio_minimal-blue'}
            );

            if (item.OS_Activation == $(this).val()) {
                $(this).iCheck('check');
            }
        });
    }
</script>

</body>
</html>